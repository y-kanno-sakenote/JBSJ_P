以下、VSCodeでそのまま docs/target_taxonomy_handoff.md に貼り付けて使える **引き継ぎ資料（作業指示書）**です。
※この資料は「対象物カテゴリを階層化（L1/L2/L3）」し、分析タブのフィルタ・可視化に反映するための設計と実装手順をまとめています。

⸻

対象物カテゴリ階層化（L1/L2/L3）引き継ぎ資料

0. 背景と目的

現状の対象物分類は以下（単層）：
	•	清酒 / 酒粕 / ビール / ワイン / 焼酎・蒸留酒
	•	麹菌 / 酵母 / 味醂・リキュール / その他食品
	•	水・環境・容器 / その他

今後、アミノ酸・有機酸など“化学成分”系も取り込みつつ、UIの混乱を避けるため、対象物を 階層（L1/L2/L3） に分離する。

ゴール
	•	検索/分析タブで「製品」「微生物」「化学成分」「環境・資材」などの 性質（L1） で粗く絞り、
	•	その配下の カテゴリ（L2） で詳細に絞る。
	•	（必要なら）具体名（L3：乳酸、グルタミン酸等）まで扱えるようにする。
	•	既存 対象物_top3 は当面維持し、後方互換を確保する。

⸻

1. 用語定義（今回の設計）

L1（性質・大分類）
	•	酒類・調味酒（製品）
	•	原料・副産物
	•	微生物
	•	化学成分
	•	製造環境・資材
	•	その他

L2（カテゴリ：UI/分析で主に使う）

L2は 20〜40程度に抑える。細かすぎるもの（乳酸/コハク酸等）は L3へ。

L3（具体名：将来拡張）

例：グルタミン酸、乳酸、酢酸、コハク酸、エステル類など
※初期は空でもOK（後から埋める前提）。

⸻

2. マスタ（初期案）

L2カテゴリ案（推奨・最小構成）

酒類・調味酒（製品）
	•	清酒
	•	ビール
	•	ワイン
	•	焼酎・蒸留酒
	•	味醂・リキュール

原料・副産物
	•	酒粕
	•	原料穀類（米・麦 等）  ※任意（最初は無くても）
	•	その他食品（発酵食品・関連食品）

微生物
	•	麹菌
	•	酵母
	•	乳酸菌
	•	その他微生物（任意）

化学成分（横断）
	•	アミノ酸
	•	有機酸
	•	糖類
	•	香気成分
	•	ペプチド・タンパク質
	•	無機成分（ミネラル等）

製造環境・資材
	•	水
	•	製造環境
	•	容器・包装

その他
	•	その他

⸻

3. 実装方針（壊さない移行）

3.1 追加する列（CSV / DataFrame）
	•	対象物_L1：複数値（例：酒類・調味酒|化学成分）
	•	対象物_L2：複数値（例：清酒|アミノ酸）
	•	対象物_L3：複数値（例：グルタミン酸|乳酸）※初期は空でOK

区切りは現行 split_multi() の仕様に合わせて「カンマ/スペース/、/;」などを許容し、保存は | 推奨（内部表現を安定させるため）。

重要：分析側は multi-label前提（explode集計）で組む。

3.2 既存列との関係
	•	対象物_top3 は当面残す（互換）
	•	分析タブ（targettype分析）では順次 対象物_L2 を優先利用
	•	互換のため、対象物_L2 が空なら 対象物_top3 を代替として使う（fallback）

⸻

4. マスタファイルの置き場所と形式（提案）

VSCodeで管理しやすいよう、以下を推奨：
	•	data/target_taxonomy.csv（マスタ）
	•	data/target_lexicon_l2.csv（判定辞書：キーワード→L2）
	•	data/target_lexicon_l3.csv（判定辞書：キーワード→L3、任意）

4.1 target_taxonomy.csv（例）

列：
	•	L1
	•	L2
	•	L3（空でもOK）
	•	aliases（同義語; 区切り |）

例（抜粋）：

L1,L2,L3,aliases
酒類・調味酒（製品）,清酒,,日本酒|清酒
酒類・調味酒（製品）,焼酎・蒸留酒,,焼酎|蒸留酒|スピリッツ
微生物,麹菌,,麹菌|Aspergillus|A. oryzae
化学成分,有機酸,,有機酸|酸組成|organic acid
製造環境・資材,容器・包装,,容器|瓶|缶|包装


⸻

5. 自動マッピング（現状データへの付与）

5.1 最小ルール（すぐ動く）
	1.	対象物_top3 を split → 各要素を L2に「そのまま」入れられるものは入れる
	2.	旧「水・環境・容器」だけは暫定で L2=水・環境・容器 に入れる（後で分割）
	3.	キーワード列（primary_keywords 等）から辞書マッチで アミノ酸/有機酸/... を L2に追加
	4.	L1は L2→L1の逆引きで付与

5.2 優先度（競合したとき）
	•	L3（具体名）> L2（集合名）> 旧top3
	•	例：本文/キーワードに「乳酸」があれば、L2=有機酸、L3=乳酸 も付与（両方持つ）

⸻

6. 分析タブ（targettype系）への影響と対応

6.1 フィルタUI（推奨）
	•	まず L1 を選択（複数可）
	•	選んだ L1 に属する L2 だけを候補に出す
	•	L2で絞り込み
	•	（任意）L3のフィルタは最初は非表示にし、将来expanderへ

6.2 可視化（負荷対策）

カテゴリ増でクロス表が見づらくなるため：
	•	“上位Nカテゴリ”表示（例：N=25）
	•	“その他”にまとめる
	•	explode集計はキャッシュ（@st.cache_data）必須

⸻

7. 具体的な作業ステップ（チェックリスト）

Phase 1：マスタ導入（安全）
	•	data/target_taxonomy.csv 作成（L1/L2の確定）
	•	DataFrameに 対象物_L1, 対象物_L2, 対象物_L3 を追加する処理を用意（初期は空でもOK）
	•	分析タブ側で 列があればL2を使う / なければtop3 fallbackを実装

Phase 2：自動付与（化学成分の取り込み）
	•	data/target_lexicon_l2.csv 作成（例：アミノ酸/有機酸/香気成分 等）
	•	キーワード列から辞書マッチ→L2追加
	•	L2→L1逆引きでL1を付与

Phase 3：改善（精度とUI）
	•	「水・環境・容器」の分割（辞書orルール）
	•	L3辞書（乳酸/コハク酸/グルタミン酸 等）導入（任意）
	•	分析タブの“共同知”集計にL1/L2を活用

⸻

8. 実装メモ（コーディング指針）

8.1 DataFrame列の扱い（multi-label）
	•	保存形式："清酒|アミノ酸" のように | 区切り
	•	UI表示：split→候補生成
	•	絞り込み：選択カテゴリ集合に対して「含む」判定

8.2 既存split関数の再利用
	•	現行 split_multi() を使う
	•	ただし | を区切りとして追加するなら、正規表現に | を含める（既に含まれているならOK）

8.3 後方互換 fallback
	•	対象物_L2 が存在しない/空 → 対象物_top3 を使う
	•	UIでも「新分類を優先（fallbackあり）」を徹底

⸻

9. テスト観点（最小）
	•	対象物_L2 追加後も検索タブの動作が変わらない（現状維持）
	•	分析タブが落ちない（列欠落でも動く）
	•	L1→L2の絞り込みが期待通り（候補が減る）
	•	代表論文で「清酒×酵母×アミノ酸」など複合付与ができる

⸻

10. 次の打ち手（優先順位）
	1.	L1/L2マスタ確定（UIの骨格）
	2.	化学成分L2の辞書付与（価値が一気に上がる）
	3.	「水・環境・容器」の分割（分析が見やすくなる）
	4.	L3は必要が見えてから（最初は無理に増やさない）

⸻

付録：L2増加の考え方（上限感）
	•	L2は 20〜40を目安（実務的に運用可能）
	•	具体名はL3へ逃がす
	•	UIはL1で候補絞り込み＋検索付きで破綻しない

⸻
